               <%
                       #
                       # Generate the 24 hour labels, showing the current hour on the right most edge and then
                       # working backwards upto to 24 hours ago.
                       #
                       currentHour = Time.now.strftime("%H").to_i + 1
                       @chartLabel24Hrs = (0..23).to_a
                       shiftedArray = @chartLabel24Hrs.shift(currentHour)
                       @chartLabel24Hrs.concat(shiftedArray)

                       @IpStatRecs= Ipstat.select("strftime('%Y-%m-%d %H', timestamp) as time, destip as ip, destport, deviceid as device, sum(inbytes) as inbytes, sum(outbytes) as outbytes").
#                                           where("timestamp >= ?", 1.day.ago.strftime("%Y-%m-%d %H:%M:%S")).
                                            where("timestamp >= ?", "2013-02-01").
                                            group(:time, :destip, :destport, :deviceid).order(:destip)

                       @ServerList = @IpStatRecs.map { |i| i.ip }.uniq
                       @DeviceList = @IpStatRecs.map { |i| i.device }.uniq

                       @ServerArray = Array.new
                       @ServerList.each do | server_ip | 

                           #Hourly stats for each server
                           data = Array.new(24,0) 

                           @IpStatRecs.map do |i| 
                                 if (i.ip == server_ip) 
                                    data[i.time.split[1].to_i] += (i.inbytes + i.outbytes)
                                 end
                           end
                           shiftedArray = data.shift(currentHour)
                           data.concat(shiftedArray)
                           @ServerArray.push(data)
                       end
                %>
<div id="content" class="span10">
<!-- content starts -->
			

   <div>
      <ul class="breadcrumb">
         <li>
            <a href="#">Bandwidth</a> <span class="divider">/</span>
         </li>
      </ul>
   </div>
			
   <div class="row-fluid sortable">		
         <div class="box span12">
            <div class="box-header well" data-original-title>
	       <h2><i class="icon-folder-open"></i> Bandwidth Consumption (Past 24 Hours)</h2>
	       <div class="box-icon">
	          <a href="#" class="btn btn-setting btn-round"><i class="icon-cog"></i></a>
	          <a href="#" class="btn btn-minimize btn-round"><i class="icon-chevron-up"></i></a>
	          <a href="#" class="btn btn-close btn-round"><i class="icon-remove"></i></a>
	       </div>
	    </div>

            <div id="tabs" class="box-content">
               <ul>
                  <li><a href="#total">Total</a></li>

                  <!-- Display graphs(in individual tab)  for total consumption and top 5 servers -->
                  <% @ServerList[0..4].each do | server_ip | %>
                     <% break if server_ip.nil? %>
                     <li><%= link_to server_ip, '#' + server_ip.gsub(/\s+/,"")  %></li>
                  <% end %>
               </ul>
               <div class="tabs-spacer"></div>
               <div id="total" class="box-content" id="divCanvas">
                  <canvas id="total_bw" width="900" height="300">[No canvas support]</canvas>
               </div> <!-- tab total  -->
               <% @ServerList[0..4].each do | server_ip | %>
                  <% break if server_ip.nil? %>
                  <div id="<%= server_ip.gsub(/\s+/,"") %>" class="box-content">
                      <%= server_ip + ' - Bandwidth usage for individual ports will be shown here. ' %>
                  </div> 
               <% end %>
            </div> <!-- box-content -->
         </div> <!-- box span12 -->
   </div><!-- row-fluid sortable -->

   <div class="row-fluid sorttable">
         <div class="box span6">
            <div class="box-header well" data-original-title>
	       <h2><i class="icon-folder-open"></i> Top Servers</h2>
	       <div class="box-icon">
	          <a href="#" class="btn btn-setting btn-round"><i class="icon-cog"></i></a>
	          <a href="#" class="btn btn-minimize btn-round"><i class="icon-chevron-up"></i></a>
	          <a href="#" class="btn btn-close btn-round"><i class="icon-remove"></i></a>
	       </div>
	    </div>

            <div class="box-content">
            <table class="table table-striped table-bordered bootstrap-datatable datatable">
               <thead>
	          <tr>
	             <th>Server</th>
		     <th>Incoming (Mbytes) </th>
                     <th>Outgoing (Mbytes)</th>
                     <th>Total (MBytes)</th>
	          </tr>
	       </thead>   
	       <tbody>
               <%
                  @ServerList.each do | server_ip | 
                     inbytes = outbytes = 0
                     @IpStatRecs.map do |i| 
                        if (i.ip == server_ip) 
                           inbytes += i.inbytes
                           outbytes += i.outbytes
                        end
                     end
               %>
                     
                     <tr>
                        <td><%= server_ip %></td>
                        <td><%= inbytes %></td>
                        <td><%= outbytes %></td>
                        <td><%= inbytes+outbytes %></td>
                     </tr>
               <% end %>
               
               </tbody>
            </table>
            </div> <!-- box-content -->
         </div> <!-- box span6 -->
         <div class="box span6">
            <div class="box-header well" data-original-title>
	       <h2><i class="icon-folder-open"></i> Top Devices </h2>
	       <div class="box-icon">
	          <a href="#" class="btn btn-setting btn-round"><i class="icon-cog"></i></a>
	          <a href="#" class="btn btn-minimize btn-round"><i class="icon-chevron-up"></i></a>
	          <a href="#" class="btn btn-close btn-round"><i class="icon-remove"></i></a>
	       </div>
	    </div>

            <div class="box-content">
            <table class="table table-striped table-bordered bootstrap-datatable datatable">
               <thead>
	          <tr>
	             <th>Device</th>
		     <th>Incoming (Mbytes) </th>
                     <th>Outgoing (Mbytes)</th>
                     <th>Total (MBytes)</th>
	          </tr>
	       </thead>   
	       <tbody>
               <%
                  @DeviceList.each do | device | 
                     inbytes = outbytes = 0
                     @IpStatRecs.map do |i| 
                        if (i.device == device) 
                           inbytes += i.inbytes
                           outbytes += i.outbytes
                        end
                     end
               %>
                     
                     <tr>
                        <td><%= device %></td>
                        <td><%= inbytes %></td>
                        <td><%= outbytes %></td>
                        <td><%= inbytes+outbytes %></td>
                     </tr>
               <% end %>
               
               </tbody>
            </table>
            </div> <!-- box-content -->
         </div> <!-- box span6 -->
   </div><!-- row-fluid sortable -->
</div><!-- content ends -->


<script type="text/javascript">
        window.onload = function ()
        {
$( "#tabs" ).tabs();

            var myLine = new RGraph.Line('total_bw', <%= @ServerArray %>);
            myLine.Set('chart.labels', <%=raw @chartLabel24Hrs.map { |i| i.to_s } %>);

            myLine.Set('chart.key', <%=raw @ServerList %>);
            myLine.Set('chart.key.color.shape', 'circle');
            myLine.Set('chart.key.position', 'graph');

            myLine.Set('chart.linewidth', 5);
            myLine.Set('chart.background.grid.autofit.numvlines', 24);
            myLine.Set('chart.background.grid.autofit.numhlines', 20);

            myLine.Set('chart.colors', ['red', 'black','#DDDF0D','#7798BF', '#ABD874', '#E18D87', '#599FD9', '#F4AD7C', '#D5BBE5']);
            myLine.Set('chart.text.color', '#333');
            myLine.Set('chart.text.font', 'Arial');
            myLine.Set('chart.background.grid.autofit', true);
            myLine.Set('chart.shadow', true);
            myLine.Set('chart.shadow.color', 'rgba(20,20,20,0.3)');
            myLine.Set('chart.shadow.blur',  10);
            myLine.Set('chart.shadow.offsetx', 0);
            myLine.Set('chart.shadow.offsety', 0);
            myLine.Set('chart.background.grid.border', true);
            myLine.Set('chart.axis.color', '#666');
            myLine.Set('chart.text.color', '#666');
            myLine.Set('chart.key.interactive', true);
            myLine.Set('chart.spline', true);
            myLine.Set('chart.title', 'Bandwidth (Mbytes)');
            //myLine.Set('chart.tickmarks', 'circle');


            /**
            * Use the Trace animation to show the chart
            */
            if (RGraph.isOld()) {
                // IE7/8 don't support shadow blur, so set custom shadow properties
                myLine.Set('chart.shadow.offsetx', 3);
                myLine.Set('chart.shadow.offsety', 3);
                myLine.Set('chart.shadow.color', '#aaa');
                myLine.Draw();
            } else {
                RGraph.Effects.Line.jQuery.UnfoldFromCenterTrace(myLine, {'duration': 1000});
            }
        }
</script>

