<%

# Selecting the top 10 ports to display in the bandwidth line graph
hashGraphTimeBasedTotals = Hash[@hashTimeIntervalData.sort_by {|key, value| value.reduce(:+)}.reverse[0..10]]

if params['reportType'] == "byodIP" then
   serverPortListTitle = "BYOD Device Ports"
   clientListTitle = @availableBandwidthReportTypes[params[:reportType]]
else
   serverPortListTitle = "Ports"
   clientListTitle = "Clients"
end

%>

<!-- content starts -->
<div id="content" class="span10">
        <div class="control-group">
            <select id="reportTime" class="chosen">
               <% @availableTimeLines.each do |key, value| %>
               <option value="<%= key %>"><%= value %></option>
               <% end %>
            </select>
                    
            <button class="btn btn-primary" id="refreshBtn">Refresh</button>

        </div>
        <div class="control-group" id="dateRange">
            <input   class="datepicker" id="fromDate" value="From" type="text" >
            <input   class="datepicker" id="toDate" value="To" type="text">
        </div>

   <div class="row-fluid sortable">		
      <div class="box span12">
         <%= render :partial => 'layouts/title_bar_icons',
                    :locals => { :header_title => "Resource Consumption for #{params[:resource]}",
                                 :header_link  => "#" }
         %>
         <div class="box-content">
            <canvas id="total_bw">[No canvas support]</canvas>
         </div>
      </div> <!-- box span12 -->
   </div><!-- row-fluid sortable -->

   <div class="row-fluid sorttable">
      <div class="box span6" id="serverList">
         <%= render :partial => 'layouts/title_bar_icons',
                    :locals => { :header_title => serverPortListTitle,
                                 :header_link  => "#" }
         %>
         <div class="box-content">
            <table class="table table-striped table-bordered bootstrap-datatable datatable">
               <thead>
	          <tr>
	             <th>Ports</th>
               <th><%= "Download" %></th>
               <th><%= "Upload" %></th>
               <th><%= "Total" %></th>
	          </tr>
	       </thead>   
	       <tbody>
               <% @hashPortTotals.each do | port, arrayTotals | %>
                     <tr>
                        <td><%= port %></td>
                        <td><%= number_to_human_size arrayTotals[0] %></td>
                        <td><%= number_to_human_size arrayTotals[1] %></td>
                        <td><%= number_to_human_size arrayTotals.reduce(:+) %></td>
                     </tr>
               <% end %>
               
               </tbody>
            </table>
         </div> <!-- box-content -->
      </div> <!-- box span6 -->

      <div class="box span6" id="clientList">
         <%= render :partial => 'layouts/title_bar_icons',
                    :locals => { :header_title => clientListTitle,
                                 :header_link  => "#" }
         %>
         <div class="box-content">
            <table class="table table-striped table-bordered bootstrap-datatable datatable">
               <thead>
	                <tr>
	                   <th>Device</th>
                     <th><%= "Download" %></th>
                     <th><%= "Upload" %></th>
                     <th><%= "Total" %></th>	                
                  </tr>
	             </thead>   
	             <tbody>
               <% @hashDeviceTotals.each do | device, clientData | %>                     
               <% if !clientData[:user].nil? && !clientData[:user].empty? then 
                     linkText = clientData[:user]
                  elsif !clientData[:ipaddress].nil? && !clientData[:ipaddress].empty? then 
                     linkText = clientData[:ipaddress]
                  else
                     linkText = device
                  end
               %>
                  <tr>
                     <td><%= link_to linkText, :action => "device_details", :device => device %></td>
                     <td><%= number_to_human_size clientData[:totals][0] %></td>
                     <td><%= number_to_human_size clientData[:totals][1] %></td>
                     <td><%= number_to_human_size clientData[:totals].reduce(:+) %></td>
                  </tr>
               <% end %>
               </tbody>
            </table>
            </div> <!-- box-content -->
         </div> <!-- box span6 -->
   </div><!-- row-fluid sortable -->
</div><!-- content ends -->


<script type="text/javascript">
        
        window.onload = function ()
        {
            //Resize the canvas element
            document.body.onresize = function () {
              var canvas = document.getElementById('total_bw');
              canvas.width = canvas.parentNode.clientWidth * 0.9;
              canvas.height = canvas.parentNode.clientHeight * 1.5;
            }

            document.body.onresize();
            var myLine = new RGraph.Line('total_bw', <%= hashGraphTimeBasedTotals.values %>);
            myLine.Set('labels', <%=raw bandwidthGraphTimeSlotLabels  %>);

            myLine.Set('key', <%=raw hashGraphTimeBasedTotals.keys %>);
            myLine.Set('key.color.shape', 'circle');
            myLine.Set('key.position', 'graph');

            myLine.Set('linewidth', 5);
            myLine.Set('background.grid.autofit.numvlines', <%= @numTimeSlots-1 %>);
            //myLine.Set('background.grid.autofit.numhlines', 10);

            myLine.Set('colors', ['red', 'black','#DDDF0D','#7798BF', '#ABD874', '#E18D87', '#599FD9', '#F4AD7C', '#D5BBE5']);
            myLine.Set('text.color', '#333');
            myLine.Set('text.font', 'Arial');
            myLine.Set('background.grid.autofit', true);
            myLine.Set('shadow', true);
            myLine.Set('shadow.color', 'rgba(20,20,20,0.3)');
            myLine.Set('shadow.blur',  10);
            myLine.Set('shadow.offsetx', 0);
            myLine.Set('shadow.offsety', 0);
            myLine.Set('background.grid.border', true);
            myLine.Set('axis.color', '#666');
            myLine.Set('text.color', '#666');
            myLine.Set('key.interactive', true);
            myLine.Set('spline', true);
            myLine.Set('title', '<%= "Bandwidth" %>');
            myLine.Set('gutter.left', 70);
            myLine.Set('gutter.right', 40);
            myLine.Set('tickmarks', 'circle');
            myLine.Set('numxticks', 0);
            myLine.Set('numyticks', 0);

            /**
            * Use the Trace animation to show the chart
            */
            if (RGraph.isOld() || (Array.max(myLine.data_arr) < 5)) {
                // IE7/8 don't support shadow blur, so set custom shadow properties
                myLine.Set('shadow.offsetx', 3);
                myLine.Set('shadow.offsety', 3);
                myLine.Set('shadow.color', '#aaa');
                myLine.Draw();
            } else {
                RGraph.Effects.Line.jQuery.UnfoldFromCenterTrace(myLine, {'duration': 1000});
            }
        }

   $(document).ready(function(){

       // Set approriate values (derived from query string) in the dropdown selections
       $("#reportTime").val("<%= params['reportTime'] || 'today' %>");

       $("#reportTime").chosen().change(function() {
           if (this.value == "date_range") {
               $("#dateRange").show();
           } else {
               $("#dateRange").hide();
           }
       });

       <% if params['reportTime'] != "date_range" then %>
          $("#dateRange").hide();
       <% else %>
          $("#dateRange").show();
          fromDate = "<%= params['fromDate'] || Date.today.to_s %>";
          $("#fromDate").val(fromDate);
          toDate = "<%= params['toDate'] || Date.today.to_s %>"
          $("#toDate").val(toDate);
       <% end %>

       $('#refreshBtn').click(function() {
            var time = $('#reportTime').val();

            var urlString = "/dash_bw_server?reportType=" + "<%= params['reportType'] %>" + "&resource=" + "<%= params['resource'] %>" + "&reportTime=" + time;
            if (time == "date_range") {
               numDays = dateDiffInDays(new Date(fromDate), new Date(toDate));

               //For now, handle date ranges less than a year
               if (numDays > 364) {
                  alert("Date ranges beyond a year are not supported.")
                  return;
               }
                             
               urlString += "&fromDate=" + fromDate + "&toDate=" + toDate;
            }
            window.location.href= urlString;
       });
       /*
        * BYOD Servers is a quirky case (unlike others) where the BYODs act as servers and other devices on the network are connecting to them via
        * SSH or other advertised ports. In all other cases, BYODs are always clients in the TCP/IP connection except here they are the Servers.
        * Instead of doing code changes all over the place, just swapping the two tables based the switched role of the BYODs to make the page
        * consistent of having the left-side table as servers and right-side table as clients, always.
        */
       <% if params['reportType'] == 'byodIP' then %>
             jQuery("#serverList").insertAfter(jQuery('#clientList'));
       <% end %>

       $(".chosen").chosen();
       $('.chzn-search').hide(); //Hide the search box within the dropdown
  

   }); //document.ready()

</script>

