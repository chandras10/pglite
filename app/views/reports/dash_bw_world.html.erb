<style>
.hoverShow {
    float:left;
    background-color: #333333;
    border-color: #FFFFFF #000000 #000000 #FFFFFF;
    border-style: solid;
    border-width: 2px;
    color: #FFFFFF;
    font-family: arial;
    font-size: 1.2em;
    width: 90%;
}
.hoverShow img {
    float:right;
}
.hoverTable {
    float:left;
}
td.right {
  text-align: right;
}
</style>
<div id="content" class="span10">
        <div class="control-group">
    			  <select id="reportTime" class="chosen">
               <% @availableTimeLines.each do |key, value| %>
    				   <option value="<%= key %>"><%= value %></option>
               <% end %>
    			  </select>
          
            <button class="btn btn-primary" id="refreshBtn">Refresh</button>
        </div>
        <div class="control-group" id="dateRange">
    			  <input   class="datepicker" id="fromDate" value="From" type="text" >
    			  <input   class="datepicker" id="toDate" value="To" type="text">
        </div>

   <div class="row-fluid sorttable">
      <div class="box span7">
         <%= render :partial => 'layouts/title_bar_icons',
                    :locals => { :header_title => "Internet Servers Accessed",
                                 :header_link  => "#" }
         %>
         <div id="vmap" class="box-content" style="width: 600px; height: 400px; overflow:auto">
         </div>
      </div>
      <div class="box span5" id="countryDetails">
         <%= render :partial => 'layouts/title_bar_icons',
                    :locals => { :header_title => "Country",
                                 :header_link  => "#" }
         %>
         <div class="box-content" >
             <input type="hidden" id="countryCode" value=""> 
             <div id="loading-indicator" style="display: none;">
                <%= image_tag("ajax-loader-8.gif") %>
             </div>
             <div class="hoverShow" style="display: none;">
               <table class="hoverTable" cellpadding="10" border="0">
                 <tbody>
                    <tr><td><b>Servers: </b></td><td id="serverCount" style='text-align: right'></td></tr>
                    <tr><td><b>Upload: </b></td><td id="uploadSize" style='text-align: right'></td></tr>
                    <tr><td><b>Download: </b></td><td id="downloadSize" style='text-align: right'></td></tr>
                    <tr><td><b>Total: </b></td><td id="totalSize" style='text-align: right'></td></tr>
                 </tbody>
               </table>
               <%= image_tag("flags_iso/128/in.png", :id => 'countryFlag', :alt => 'Country Flag') %>
            </div>
            <table id="servers" class="display" data-source="/dash_bw_country_details.json%>">
            <thead>  
              <tr>
                <th>Server</th>
                <th>Port</th>
                <th>Upload</th>
                <th>Download</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
            </table>
         </div>

      </div>
   </div>
</div><!-- content ends -->


<script type="text/javascript">
   var mapData;
   var _MS_PER_DAY = 1000 * 60 * 60 * 24;
   function dateDiffInDays(a, b) {
      // Discard the time and time-zone information.
      var utc1 = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
      var utc2 = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());

      return Math.floor((utc2 - utc1) / _MS_PER_DAY) + 1; // Adding one extra to make the end date inclusive.
   }
        
       function formatNumber(nStr) {
                                           label = " MB";
                                           num = parseFloat(nStr);
                                           if (num > 1024.0) {
                                              nStr = ((num/1024).toFixed(2)).toString();
                                              label = " GB"
                                           } else {
                                              nStr = num.toFixed(2).toString();
                                           }

                                           nStr += '';
                                           x = nStr.split('.');
                                           x1 = x[0];
                                           x2 = x.length > 1 ? '.' + x[1] : '';
                                           var rgx = /(\d+)(\d{3})/;
                                           while (rgx.test(x1)) {
                                              x1 = x1.replace(rgx, '$1' + ',' + '$2');
                                           }
                                           return x1 + x2 + label;
       }

   $(document).ready(function(){
       var fromDate, toDate;

       // Set approriate values (derived from query string) in the dropdown selections
       $("#reportTime").val("<%= params['reportTime'] || 'today' %>");

       <% if params['reportTime'] != "date_range" then %>
          $("#dateRange").hide();
       <% else %>
          $("#dateRange").show();
          fromDate = "<%= params['fromDate'] || Date.today.to_s %>";
          $("#fromDate").val(fromDate);
          toDate = "<%= params['toDate'] || Date.today.to_s %>"
          $("#toDate").val(toDate);
       <% end %>

       $("#reportTime").chosen().change(function() {
           if (this.value == "date_range") {
               $("#dateRange").show();
           } else {
               $("#dateRange").hide();
           }
       });

       $("#fromDate" ).datepicker({ 
              showAnim: "slide",        
              dateFormat: "yy-mm-dd",
              onSelect: function(dateText){
                 fromDate = dateText;
              },
              onClose: function( selectedDate ) {
                 $( "#toDate" ).datepicker( "option", "minDate", selectedDate );
              }              
       });
       $("#toDate" ).datepicker({ 
              showAnim: "slide",
              dateFormat: "yy-mm-dd",
              onSelect: function(dateText){
                 toDate = dateText;
              },
              onClose: function( selectedDate ) {
                 $( "#fromDate" ).datepicker( "option", "maxDate", selectedDate );
              } 
       });


  
  
       $('#refreshBtn').click(function() {
            var time = $('#reportTime').val();

            var urlString = "/dash_bw_world?reportTime=" + time;
            if (time == "date_range") {
               numDays = dateDiffInDays(new Date(fromDate), new Date(toDate));

               //For now, handle date ranges less than a year
               if (numDays > 364) {
                  alert("Date ranges beyond a year are not supported.")
                  return;
               }
               urlString += "&fromDate=" + fromDate + "&toDate=" + toDate;
            }

            window.location.href= urlString;
       });

       $(".chosen").chosen();
       $('.chzn-search').hide(); //Hide the search box within the dropdown


       mapData = <%=raw @totalBWPerCountry.to_json %>;
   }); //document.ready()
</script>

<%= javascript_include_tag "dash_bw_world.js.coffee" %>
